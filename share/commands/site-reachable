#!/bin/bash

long_usage_message="usage: $(basename $0) site-reachable [<site>]
Check to see if the given site is accessible via https.

Arguments
  <site> - Optionally, pass the site you want to check. If empty, check all sites."

long_check_args "$2" "$#" 0

sites="$2"

if [ -z "$sites" ]; then
  long_set_sites
  sites="$LONG_SITES"
fi
timeout=10
total_count=0
online_count=0
offline_count=0
for site in $sites; do
  total_count=$(( $total_count + 1 ))
  # Ensure anonymous access to the page generates a login box.
  if ! curl -s --max-time "$timeout" https://${site}.ourpowerbase.net  | grep "block-user-login" >/dev/null; then
    offline_count=$(( $offline_count + 1 ))
    long_log "Site %s is OFFLINE!!!" error "$site"
  else
    online_count=$(( $online_count + 1 ))
    long_log "Site %s is online" info "$site"
  fi
done

long_log "Total checked: %s" info "$total_count"
long_log "Total online: %s" info "$online_count"
long_log "Total offline: %s" info "$offline_count"

