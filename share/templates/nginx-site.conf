# This file was generated from a template. Don't edit the generated file.
# Special thanks to http://wiki.nginx.org/Drupal
server {
  LONG_TLS_OR_NOT
  access_log /var/log/nginx/LONG_ACCESS_LOG;
  server_name LONG_SITE_URL; 
  root  LONG_WEB_ROOT;

  # Enable compression, this will help if you have for instance advagg module
  # by serving Gzip versions of the files.
  gzip_static on;

  location = /favicon.ico {
    log_not_found off;
    access_log off;
  }

  location = /robots.txt {
    allow all;
    log_not_found off;
    access_log off;
  }

  # Very rarely should these ever be accessed outside of your lan
  location ~* \.(txt|log|sql)$ {
    deny all;
  }

  location ~ \..*/.*\.php$ {
    return 403;
  }

  # Protect drupal private files... 
  location ~ ^/sites/.*/private/ {
    return 403;
  }

  # ... and CiviCRM private files. For more info on CiviCRM no no files:
  # https://civicrm.org/advisory/civi-sa-2014-001-risk-information-disclosure
  location ~ ^/sites/.*/files/civicrm/(ConfigAndLog|upload|templates_c|custom)/ {
    deny all;
  }

  # Block access to "hidden" files and directories whose names begin with a
  # period. This includes directories used by version control systems such
  # as Subversion or Git to store control files.
  location ~ (^|/)\. {
    return 403;
  }

  # Ensure that this site's sites/default and sites/domain map properly on the host. 
  location /sites/default/ {
    alias /srv/longshore/services/sites/LONG_SITE/drupal/;
  }
  location /sites/LONG_SITE_URL/ {
    alias /srv/longshore/services/sites/LONG_SITE/drupal/;
  } 

  location / {
    # This is cool because no php is touched for static content
    try_files $uri @rewrite;
  }

  location @rewrite {
    # For D7 and above clean URLs are handled in drupal_environment_initialize().
    rewrite ^ /index.php;
  }

  # Avoid "Request Entity Too Large" errors on imports.
  client_max_body_size 30M;

  location ~ \.php$ {
    fastcgi_split_path_info ^(.+\.php)(/.+)$;
    #NOTE: You should have "cgi.fix_pathinfo = 0;" in php.ini
    fastcgi_intercept_errors on;
    fastcgi_pass   localhost:LONG_CGI_PORT;
    include        fastcgi_params;
    # Override default SCRIPT_FILENAME because the php container uses a
    # different base directory than the host.
    fastcgi_param  SCRIPT_FILENAME  /var/www/powerbase$fastcgi_script_name;
    fastcgi_buffer_size 128k;
    fastcgi_buffers 256 4k;
    fastcgi_busy_buffers_size 256k;
    fastcgi_temp_file_write_size 256k;
    # Set long timeouts to ensure it works with big imports.
    fastcgi_send_timeout 1800;
    fastcgi_read_timeout 1800;
    proxy_read_timeout 1800;
  }
}
